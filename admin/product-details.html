<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detil Produk | Jajan Yuk</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="../images/chicken.svg" type="image/x-icon">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <!-- User Defined Styles -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- Manifest.json -->
    <link rel="manifest" href="./manifest.json">
    <style>
        img:hover {
            transition-duration: 500ms;
            opacity: .9;
        }
        textarea {
            resize: none;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid mb-5">
        <div class="row">
            <div class="col-2 d-none d-lg-block bg-white overflow-auto position-fixed w-100 vh-100 py-4">
                <nav class="d-flex flex-column h-100">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-primary" href="./dashboard.html">Dashboards</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-secondary" href="./dashboard.html#product-orders" id="product-orders">Product Orders</a>
                        </li>
                        <li class="nav-item" data-toggle="collapse" href="#product-collapse">
                            <div class="d-flex">
                                <a class="nav-link text-muted">Products</a>
                                <span class="ml-auto">&darr;</span>
                            </div>
                
                            <div class="collapse" id="product-collapse">
                                <ul class="nav flex-column ml-4 pl-1">
                                    <li class="nav-item">
                                        <a class="nav-link text-secondary" href="./dashboard.html#all-products" id="all-products">All Products</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link text-secondary" href="./dashboard.html#add-product" id="add-product">Add Products</a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="nav-item" data-toggle="collapse" href="#employee-collapse">
                          <div class="d-flex">
                            <a class="nav-link text-muted" href="#">Employees</a>
                            <span class="ml-auto">&darr;</span>
                          </div>
                
                          <div class="collapse" id="employee-collapse">
                            <ul class="nav flex-column ml-4 pl-1">
                                <li class="nav-item">
                                    <a class="nav-link text-secondary" href="./dashboard.html#all-employee" id="all-employee">All Employee</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link text-secondary" href="./dashboard.html#add-employee" id="add-employee">Add Employee</a>
                                </li>
                            </ul>
                        </div>
                        </li>
                    </ul>
                    <ul class="nav flex-column h-100 justify-content-end">
                        <li class="nav-item">
                            <a class="btn btn-block btn-danger" href="#" id="logout-button"><i data-feather="power"></i> Logout</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="col-lg-10 py-4 ml-auto">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="./dashboard.html">Dashboard</a></li>
                        <li class="breadcrumb-item active" id="current-page" aria-current="page"></li>
                    </ol>
                </nav>
                <div class="col-12" id="product-alert-container"></div>
                <div class="" id="alert-container" data-dismiss="alert"></div>
                <div class="row">
                    <div class="col-12 d-flex mb-2">
                        <h3 class="font-weight-bold">Product Details</h3>
                        <div class="ml-auto">
                            <a href="dashboard.html" class="btn btn-secondary">Back</a>
                        </div>
                    </div>
                </div>
                <div class="row" id="product-detail-container">
                    <div class="col d-flex justify-content-center">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation Bar On Mobile -->
    <nav class="bg-white border-top fixed-bottom d-lg-none d-flex justify-content-center align-items-center w-100 py-2">
        <a href="../index.html" class="d-flex flex-column justify-content-center align-items-center flex-grow-1 text-secondary small">
            <i class="fas fa-home text-small"></i>
            <span>Home</span>
        </a>
        <a href="./dashboard.html" class="d-flex flex-column justify-content-center align-items-center flex-grow-1 text-secondary small">
            <i class="fas fa-home text-small"></i>
            <span>All Product</span>
        </a>
        <a href="./add-product.html" class="d-flex flex-column justify-content-center align-items-center flex-grow-1 text-secondary small">
            <i class="fas fa-heart"></i>
            <span>Add Product</span>
        </a>
    </nav>
   <!-- Bootstrap -->
   <script src="../js/jquery-3.5.1.slim.min.js"></script>
   <script src="../js/popper.min.js"></script>
   <script src="../js/bootstrap.min.js"></script>
    <script type="module">
        import {getIdProductAdmin, addProductAdmin, updateProductAdmin, deleteProductAdmin} from "../js/services/api/admin/crud-admin.js";
        import {showProductDetail, showProductDetailAfterUpdate} from "../js/helpers/crud-admin-helper.js";
        import {logoutATAPI} from "../js/services/api/logout-token.js";
        import {refreshTokenAPI} from "../js/services/api/refresh-token.js";
        import {isTokenExpired} from "../js/helpers/token-expired-helper.js";
        
        let urlParams = new URLSearchParams(window.location.search);
        let idParam = urlParams.get("id");

        const TOKEN = JSON.parse(localStorage.getItem("TOKEN")) ?? null;
        if(TOKEN == null){
            location.href = "../login.html";
            sessionStorage.setItem("message", "Waktu Anda Telah Habis, Harap Masuk Kembali");
        }
        else {
            const {data: {access_token, refresh_token}} = TOKEN;
            getIdProductAdmin(idParam, access_token)
            .then(response => {
                if(response.msg =="token expired"){
                    refreshTokenAPI(access_token)
                        .then(response => isTokenExpired(response, access_token, "./login.html"));
                }
                if(response.msg == "Token has been revoked"){
                    localStorage.removeItem("TOKEN");
                    location.href = "./login.html";
                }
                showProductDetail(response);

                const currentPageContainer = document.getElementById("current-page");
                const titleContainer = document.getElementById("title");
                let pathBase64 = null;
                const pathHiddenInput = document.getElementById("path-hidden-input");
                const pathInput = document.getElementById("path");
                pathInput.addEventListener("click", function(){
                    pathHiddenInput.click();
                    pathHiddenInput.addEventListener("change", function(){
                        const file = event.target.files[0];
                        const reader = new FileReader();
                        reader.addEventListener("load", function(event){
                            pathBase64 = reader.result.slice(22);
                            pathInput.src = reader.result;
                        });
                        if(file){
                            reader.readAsDataURL(file);
                        }
                    });
                });
                const productAlertContainer = document.getElementById("product-alert-container");
                const alertContainer = document.getElementById("alert-container");
                const nameInput = document.getElementById("name");
                const descriptionInput = document.getElementById("description");
                const priceInput = document.getElementById("price");
                const categoryIdInput = document.getElementById("categoryid");
                const showHideInput = document.getElementById("show_hide");
                const updateButtonInput = document.getElementById("update-button");

                updateButtonInput.addEventListener("click", function(event){
                let selectedImage = pathBase64 ?? null;
                if(nameInput.value && descriptionInput.value && priceInput.value && categoryIdInput && showHideInput.value !== null){
                    updateButtonInput.innerHTML =  "Diproses...";
                    updateProductAdmin(idParam, nameInput.value, descriptionInput.value, priceInput.value, categoryIdInput.value, showHideInput.value, selectedImage, access_token)
                    .then(response => {
                        if(response.msg == "Update success"){
                            productAlertContainer.innerHTML = null;
                            updateButtonInput.innerHTML =  "Update";
                            sessionStorage.setItem("message", `Produk ${nameInput.value} Berhasil Diupdate`);
                            getIdProductAdmin(idParam, access_token)
                            .then(response => {     
                                productAlertContainer.innerHTML = `<div class="alert alert-success alert-dismissible fade show">
                                                                        ${sessionStorage.getItem("message")}
                                                                        <button type="button" class="close" data-dismiss="alert">
                                                                        <span>&times;</span></button>
                                                                    </div>`;
                                showProductDetailAfterUpdate(response);
                                sessionStorage.removeItem("message");
                            });
                        }
                    });
                }
                else {
                    let error = [];
                                if(nameInput.value == ""){
                                    error.push("Silahkan isi kolom nama");
                                }
                                if(priceInput.value == ""){
                                    error.push("Silahkan isi kolom harga")
                                }
                                if(categoryIdInput.value == ""){
                                    error.push("Silahkan isi kolom kategori");
                                }
                                if(showHideInput.value == ""){
                                    error.push("Silahkan isi pilih tampilkan atau sembunyikan produk");
                                }
                                let errorRaw = "";
                                error.forEach(element => {
                                    errorRaw += `<li>${element}</li>`;
                                });
                                productAlertContainer.innerHTML = `<div class="alert alert-danger">
                                                                    <p>Silahkan isi semua kolom !</p>
                                                                    <ul>
                                                                        ${errorRaw}
                                                                    </ul>
                                                                </div>`;
                }
            });
            const deleteButtonContainer = document.getElementById("delete-button");
            deleteButtonContainer.addEventListener("click", function(event){
                deleteProductAdmin(idParam, access_token)
                    .then(response => {
                        const nameInput = document.getElementById("name").value;
                        sessionStorage.setItem("message", `Produk ${nameInput} Berhasil Dihapus`);
                        location.href = "./dashboard.html";
                    });
            });
            });
            
            const logoutButton = document.getElementById("logout-button");
                    logoutButton.addEventListener("click", function(){
                        logoutButton.innerHTML += "...";
                        logoutATAPI(access_token).then(response => {
                            if(response.msg == "Successfully logged out"){
                                localStorage.removeItem("TOKEN");
                                location.href = "login.html";
                            }
                        });
                    });
        }
    </script>
</body>
</html>