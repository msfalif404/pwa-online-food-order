<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daftar | Jajan Yuk</title>
    <!-- Favicon -->
    <link rel="shortcut icon" href="../images/chicken.svg" type="image/x-icon">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <!-- User Defined Styles -->
    <link rel="stylesheet" href="../css/style.css">
    <!-- Manifest.json -->
    <link rel="manifest" href="./manifest.json">
</head>
<body class="vh-100">
    <div class="container py-4 py-lg-3">
        <div class="row d-flex align-items-center justify-content-center vh-100">
            <div class="col-12 col-md-6 col-lg-4 overflow-auto">
                <div class="mb-4">
                    <h3 class="text-center">Sign Up</h3>
                    <p class="text-muted text-center font-weight-600">Daftar untuk menikmati produk kami</p>
                </div>
                <div class="mb-4" id="alert-container" data-dismiss="alert"></div>
                <div class="mb-4">
                    <form id="register-form">
                        <div class="form-group">
                            <label for="full-name">Nama Lengkap</label>
                            <input type="text" name="full-name" id="full-name" class="form-control" placeholder="Masukan Nama Lengkap Anda" required="required" min="1">
                        </div>
                        <div class="form-group">
                            <label for="handphone">Nomor Handphone</label>
                            <input type="text" name="handphone" id="handphone" class="form-control" placeholder="Masukan Nomor Handphone Anda" required="required" maxlength="15">
                        </div>
                        <div>
                            <label>Tanggal Lahir</label>
                            <div class="form-row">
                                <div class="form-group col-4">
                                    <input type="text" name="days" id="days" class="form-control" placeholder="dd" required minlength="1" maxlength="2">
                                </div>
                                <div class="form-group col-4">
                                    <select name="months" id="months" class="form-control" required>
                                        <option selected disabled hidden>mm</option>
                                        <option value="01">Januari</option>
                                        <option value="02">Februari</option>
                                        <option value="03">Maret</option>
                                        <option value="04">April</option>
                                        <option value="05">Mei</option>
                                        <option value="06">Juni</option>
                                        <option value="07">Juli</option>
                                        <option value="08">Agustus</option>
                                        <option value="09">September</option>
                                        <option value="10">Oktober</option>
                                        <option value="11">November</option>
                                        <option value="12">Desember</option>
                                    </select>
                                </div>
                                <div class="form-group col-4">
                                    <input type="text" name="years" id="years" class="form-control" placeholder="yyyy" required minlength="4" maxlength="4">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Jenis Kelamin</label>
                            <div>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input class="custom-control-input" type="radio" name="gender" id="male" value="L" required>
                                    <label class="custom-control-label" for="male">Laki-laki</label>
                                  </div>
                                  <div class="custom-control custom-radio custom-control-inline">
                                    <input class="custom-control-input" type="radio" name="gender" id="female" value="P">
                                    <label class="custom-control-label" for="female">Perempuan</label>
                                  </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" name="email" id="email" class="form-control" placeholder="Email atau Nomor Telepon" required="required">
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" name="password" id="password" class="form-control" placeholder="Password" required="required" minlength="8" maxlength="16">
                        </div>
                    </form>
                </div>
                <div class="d-flex mb-3">
                    <input type="submit" value="Daftar" class="btn btn-primary btn-block py-2 text-center font-weight-500" form="register-form">
                </div>
                <div class="text-center">
                    <p class="text-muted small">Sudah mempunyai akun ? <a href="./login.html">Masuk sekarang</a></p>
                </div>
            </div>
        </div>
    </div>
    <!-- <div class="container my-lg-4 vh-100 vh-100-mobile bg-white shadow-lg">
        <div class="row h-100">
            <div class="col-lg-6 d-none d-lg-block" style="background-image: url(../images/pizza.jpg);object-fit: cover;background-size: cover;background-position: center;background-repeat: no-repeat;background-position-y: 0;"></div>
            <div class="col-lg-6 bg-white py-4 d-flex flex-column justify-content-center align-items-center">
                <h1>Selamat Datang</h1>
                <h3 class="lead">Sebelum Jajan, Harus Daftar Dulu Nih !</h3>
                <form action="register.html" method="post" class="pt-3" id="register-form">
                    <div class="form-group">
                        <label for="name">Nama Lengkap</label>
                        <input type="text" name="name" id="name" class="form-control" placeholder="Nama Lengkap" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Nomor Handphone</label>
                        <input type="tel" name="phone" id="phone" class="form-control" placeholder="Nomor Handphone" required>
                    </div>
                    <div>
                        <label>Tanggal Lahir</label>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <input type="text" name="days" id="days" class="form-control" placeholder="dd" required>
                            </div>
                            <div class="form-group col-4">
                                <select name="months" id="months" class="form-control" required>
                                    <option selected disabled hidden>mm</option>
                                    <option value="01">Januari</option>
                                    <option value="02">Februari</option>
                                    <option value="03">Maret</option>
                                    <option value="04">April</option>
                                    <option value="05">Mei</option>
                                    <option value="06">Juni</option>
                                    <option value="07">Juli</option>
                                    <option value="08">Agustus</option>
                                    <option value="09">September</option>
                                    <option value="10">Oktober</option>
                                    <option value="11">November</option>
                                    <option value="12">Desember</option>
                                </select>
                            </div>
                            <div class="form-group col-4">
                                <input type="text" name="years" id="years" class="form-control" placeholder="yyyy" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Jenis Kelamin</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gender" id="male" value="L" required>
                                <label class="form-check-label" for="male">Laki-laki</label>
                              </div>
                              <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="gender" id="female" value="P">
                                <label class="form-check-label" for="female">Perempuan</label>
                              </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" name="email" id="email" class="form-control" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" name="password" id="password" class="form-control" placeholder="Password" required>
                    </div>
                    <div>
                        <button type="submit" class="btn btn-orange btn-lg btn-block text-white">Daftar</button>
                    </div>
                    <div class="my-4 text-center">
                        <p class="text-muted">Already Have An Account ? <a class="text-orange text-bold" href="./login.html">Login Here</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div> -->

    <!-- Bootstrap -->
    <script src="../js/jquery-3.5.1.slim.min.js"></script>
    <script src="../js/popper.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <!-- User Defined Scripts -->
    <script type="module">
        import {registerCustomerAPI, verifyCustomerOTPAPI, resendOTPAPI} from "../js/services/api/customer/auth-customer.js";

        const CUSTOMER_TOKEN = JSON.parse(localStorage.getItem("CUSTOMER_TOKEN")) ?? null;
        if(CUSTOMER_TOKEN != null){
            location.href = "../index.html";
        }
        else {
            // Global value
            let customerName = "";
            let customerEmail = "";

            const registerForm = document.getElementById("register-form");
            registerForm.addEventListener("submit", function(event){
                event.preventDefault();
                const alertContainer = document.getElementById("alert-container");
                const nameInput = document.getElementById("full-name").value;
                const phoneInput = document.getElementById("handphone").value;
                const daysInput = document.getElementById("days").value;
                const monthsInput = document.getElementById("months").value;
                const yearsInput = document.getElementById("years").value;
                const birthdayInput = `${yearsInput}-${monthsInput}-${daysInput}`;
                
                // Check if the male radio button is checked or not
                // If it's checked, then take value.
                // But, if the female radio button is checked then take the value
                // But if it's no one checked, the value is null
                const genderInput = document.getElementById("male").checked ? document.getElementById("male").value : document.getElementById("female").checked ? document.getElementById("female").value : null;
                const emailInput = document.getElementById("email").value;
                const passwordInput = document.getElementById("password").value;
                
                customerName = nameInput;
                customerEmail = emailInput;

                registerForm[9].value = "Diproses...";
                registerCustomerAPI(nameInput, phoneInput, birthdayInput, genderInput, emailInput, passwordInput)
                    .then(response => {
                        if(response.msg == "Already account email"){
                            registerForm[9].value = "Daftar";
                            alertContainer.classList.add("alert", "alert-danger", "alert-dismissible", "fade", "show");
                            alertContainer.innerHTML = `Pendaftaran gagal, email sudah terpakai ! <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>`;
                        }
                        else if(response.msg == "Already phone number"){
                            registerForm[9].value = "Daftar";
                            alertContainer.classList.add("alert", "alert-danger", "alert-dismissible", "fade", "show");
                            alertContainer.innerHTML = `Pendaftaran gagal, nomor handphone sudah terpakai ! <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>`;
                        }
                        else if(response.msg == "Success, please check your email in spam or main"){
                            registerForm[9].value = "Verifikasi";
                            alertContainer.classList.add("alert", "alert-success", "alert-dismissible", "fade", "show");
                            alertContainer.innerHTML = `Pendaftaran berhasil, silahkan cek email anda ! <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>`;

                            const {data: {key}} = response;
                            registerForm.innerHTML = `<div>
                            <label>Masukan OTP Yang Telah Dikirimkan Ke Email Anda (Mungkin Terdapat Di Folder Spam Atau Folder Utama)</label>
                            <div class="form-row d-flex justify-content-center align-items-center">
                                <div class="form-group col-2">
                                    <input type="text" class="form-control bg-light otp" required maxlength="1">
                                </div>
                                <div class="form-group col-2">
                                    <input type="text" class="form-control bg-light otp" required maxlength="1">
                                </div>
                                <div class="form-group col-2">
                                    <input type="text" class="form-control bg-light otp" required maxlength="1">
                                </div>
                                <div class="form-group col-2">
                                    <input type="text" class="form-control bg-light otp" required maxlength="1">
                                </div>
                                <div class="form-group col-2">
                                    <input type="text" class="form-control bg-light otp" required maxlength="1">
                                </div>
                                <div class="form-group col-2">
                                    <input type="text" class="form-control bg-light otp" required maxlength="1">
                                </div>
                            </div>
                        </div>
                        <div class="form-row d-flex justify-content-center align-items-center text-center"><div class="form-group col-10"><button class="text-primary btn" id="resend-otp">Kirim ulang kode OTP</button></div></div>`;

                        const resendOTPButton = document.getElementById("resend-otp");
                        resendOTPButton.addEventListener("click", function(event){
                            resendOTPButton.innerHTML = "Mengirim Kode OTP...";
                            resendOTPAPI(customerName, customerEmail).then(response => {
                                if(response.msg == "Success, please check your email in spam or main"){
                                    resendOTPButton.innerHTML = "Kirim Ulang Kode OTP";
                                    alertContainer.classList.add("alert", "alert-success", "alert-dismissible", "fade", "show");
                                    alertContainer.innerHTML = "Kode OTP Berhasil dikirim ulang, silahkan cek email anda";
                                }
                            });
                        });

                            registerForm.addEventListener("submit", function(event){
                                let otpArray = [];
                                const otpInput = document.querySelectorAll(".otp");
                                otpInput.forEach(element => {
                                    otpArray.push(element.value);
                                });
                                let otpString = otpArray.join('');
                                registerForm[6].value = "Diproses...";
                                verifyCustomerOTPAPI(key, otpString)
                                    .then(response => {
                                        if(response.msg == "Incorrect OTP"){
                                            registerForm[6].value = "Verifikasi";
                                            document.getElementById("alert-container").classList.add("alert", "alert-danger", "alert-dismissible", "fade", "show");
                                            document.getElementById("alert-container").innerHTML = `Kode OTP yang diberikan salah, silahkan cek kembali ! <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>`;
                                        }
                                        else if(response.msg == "OTP Expired"){
                                            registerForm[6].value = "Verifikasi";
                                            document.getElementById("alert-container").classList.add("alert", "alert-danger", "alert-dismissible", "fade", "show");
                                            document.getElementById("alert-container").innerHTML = `Kode OTP kadaluarsa, silahkan muat ulang dan daftar kembali ! <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>`;
                                        }
                                        else if(response.msg == "Success"){
                                            sessionStorage.setItem("message", "Pendaftaran berhasil, silahkan masuk terlebih dahulu");
                                            location.href = "../login.html";
                                        }
                                    });
                            });
                        }
                    });
                });
        }
    </script>
</body>
</html>